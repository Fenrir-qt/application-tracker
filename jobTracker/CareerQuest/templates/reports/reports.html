{% extends 'base.html' %}
{% load static %}
{% block title %}Reports | CareerQuest{% endblock %}

{% block head_extra %}
  <link rel="stylesheet" href="{% static 'css/reports.css' %}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
{% endblock %}

{% block content %}
  {% include 'includes/navbar.html' %}
  <main class="container py-4 reports-page">
    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <div class="d-flex flex-column flex-md-row align-items-md-end gap-3 justify-content-between mb-3">
      <div>
        <h3 class="mb-1">Reports</h3>
        <p class="text-muted mb-0">Visualize your applications and outcomes.</p>
      </div>
      <div class="d-flex flex-wrap gap-2 filter-bar">
        <div class="input-group input-group-sm date-range">
          <span class="input-group-text"><i class="bi bi-calendar-week"></i></span>
          <input type="date" class="form-control" placeholder="From">
          <input type="date" class="form-control" placeholder="To">
        </div>
        <select class="form-select form-select-sm status-select" aria-label="Status">
          <option value="">All Statuses</option>
          <option>Pending</option>
          <option>Interview</option>
          <option>Offer</option>
          <option>Rejected</option>
        </select>
        <div class="btn-group btn-group-sm export-group" role="group">
          <button class="btn btn-outline-secondary"><i class="bi bi-download"></i> CSV</button>
          <button class="btn btn-outline-secondary"><i class="bi bi-filetype-pdf"></i> PDF</button>
        </div>
      </div>
    </div>

    <div class="row g-3 charts-row">
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">Applications by Status</h5>
            <div class="ratio ratio-16x9">
              <canvas id="statusChart"></canvas>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12 col-lg-6">
        <div class="card h-100">
          <div class="card-body">
            <h5 class="card-title">Applications Over Time</h5>
            <div class="ratio ratio-16x9">
              <canvas id="timeSeriesChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card mt-3">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="mb-0">Detailed Records</h5>
          <div class="d-none d-md-block small text-muted">Tap a row on mobile to expand</div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Company</th>
                <th>Position</th>
                <th>Status</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody>
              {% for r in reports %}
              <tr>
                <td>{{ r.company }}</td>
                <td>{{ r.job_name }}</td>
                <td><span class="badge bg-secondary">{{ r.status }}</span></td>
                <td>{{ r.application_date }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="4" class="text-center py-4">No report data available.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </main>
{% endblock %}

{% block scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
      new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: ['Pending','Interview','Offer','Rejected'],
          datasets: [{ data: [5,3,1,2], backgroundColor: ['#0d6efd','#198754','#fd7e14','#dc3545'] }]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }
    const timeCtx = document.getElementById('timeSeriesChart');
    if (timeCtx) {
      new Chart(timeCtx, {
        type: 'line',
        data: {
          labels: ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'],
          datasets: [{ label: 'Applications', data: [1,2,0,3,1,0,2], borderColor: '#0d6efd', tension: .3 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });
    }
  </script>
{% endblock %}
