
{% extends 'base.html' %}
{% load static %}
{% block title %}Dashboard | CareerQuest{% endblock %}

{% block head_extra %}
    <link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" integrity="sha384-tViUnnbYAV00FLIhhi3v/dWt3Jxw4gZQcNoSCxCIFNJVCx7/D55/wXsrNIRANwdD" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.css"/>
    <script src="https://kit.fontawesome.com/e22f460aec.js" crossorigin="anonymous"></script>
{% endblock %}

{% block content %}

    {% include 'includes/navbar.html' %}
    
    <main>
        <h4 class="user-greeting">Hello, {{ username }}!</h4>
        <!-- Cards -->
        <div class="dash-card-container">
            <div class="cards link-cards">
                <div class="card-body">
                    <h4 class="card-title quickLinksTitle"><span><i class="bi bi-lightning-charge-fill"></i>&nbsp;Quick Access</span></h4>
                    <div class="card-text quickLinks">
                        <span><i class="fa-brands fa-square-linkedin"></i>&nbsp;<a href="https://linkedin.com" target="_blank" rel="noreferrer" >Linkedin</a></span>
                        <span><i class="fa-solid fa-briefcase"></i>&nbsp;<a href="https://indeed.com" target="_blank" rel="noreferrer" >Indeed</a></span>
                        <span><i class="fa-brands fa-searchengin"></i>&nbsp;<a href="https://glassdoor.com" target="_blank" rel="noreferrer" >Glassdoor</a></span>
                    </div>
                </div>
            </div>
            <div class="cards application-sent-cards">
                <div class="card-body">
                    <h4 class="card-title application-title"><span><i class="bi bi-send-check-fill"></i>&nbsp;Application/s Sent:</span></h4>
                    <div class="card-text sent-number">
                         <p class="text-black">{{ total_jobs }}</p>
                    </div>
                </div>
            </div>
            <div class="cards job-offers-cards">
                <div class="card-body">
                    <h4 class="card-title offer-title"><span><i class="bi bi-emoji-laughing"></i>&nbsp;Offers Received:</span></h4>
                    <div class="card-text sent-number">
                        <p class="text-black">{{ total_offers }}</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Alert when creating, updating, deleting records -->
        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">
                {{ message }}
            </div>
            {% endfor %}
        {% endif %}
        <!-- Reports -->
        <section id="reports" class="mt-3">
            <div class="row g-3">
                <div class="col-12 col-lg-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-pie-chart-fill"></i> Applications by Status</h5>
                            <div class="ratio ratio-16x9">
                                <canvas id="statusChart"
                                  data-pending="{{ total_pending|default:0 }}"
                                  data-accepted="{{ total_accepted|default:0 }}"
                                  data-noresponse="{{ total_noresponse|default:0 }}"
                                  data-offer="{{ total_offers|default:0 }}"
                                  data-rejected="{{ total_rejected|default:0 }}"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6">
                    <div class="card h-100">
                        <div class="card-body">
                            <h5 class="card-title"><i class="bi bi-list-check"></i> Quick Stats</h5>
                            <ul class="list-group list-group-flush">
                                <li class="list-group-item d-flex justify-content-between align-items-center">Pending <span class="badge bg-primary rounded-pill">{{ total_pending|default:0 }}</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">Accepted <span class="badge bg-success rounded-pill">{{ total_accepted|default:0 }}</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">No Response <span class="badge bg-secondary rounded-pill">{{ total_noresponse|default:0 }}</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">Offered <span class="badge bg-warning text-dark rounded-pill">{{ total_offers|default:0 }}</span></li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">Rejected <span class="badge bg-danger rounded-pill">{{ total_rejected|default:0 }}</span></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Desktop View -->
        <div class="table-container">
            <div class="table-head">
               <h4>Applications</h4>
               <div class="table-header-buttons">
                <input type="search" name="search-application" id="search-application" placeholder="Search" class="search-application form-control">
                <button class="btn btn-primary" id="addBtn" data-bs-toggle="modal" data-bs-target="#addApplicationModal">+ Add Application</button> 
               </div>
               
            </div>
            
            <table class="table table-responsive table-reflow rounded overflow-hidden">
                <thead class="table-primary">
                    <th>Company</th>
                    <th>Position/Title</th>
                    <th>Description</th>
                    <th >Status</th>
                    <th>Date Applied</th>
                </thead>
                <tbody>
                    {% for job in jobs %}
                    <tr data-bs-toggle="modal" data-bs-target="#actionsModal{{ job.id }}" data>
                        <td id="companyCell"><span><p>&nbsp;</p>{{ job.company }}</span></td>
                        <td id="jobCell"><span><p>&nbsp;</p>{{ job.job_name }}</span></td>
                        <td id="descCell"><span><p>&nbsp;</p>{{ job.job_desc }}</span></td>
                        <td data-value="{{job.status}}" id="statusCell"><span><i class="bi bi-dot statusDot"></i>{{ job.status }}</span></td>
                        <td id="dateCell"><span><p>&nbsp;</p>{{ job.application_date }}</span></td>
                        {% empty %}
                        <td colspan="5"><h5>No records found.</h5></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Mobile View -->
        {% if jobs %}
            {% for job in jobs %}
            <div class="card-container">
                <div class="card">
                    <div class="card-body">
                        <div class="card-head">
                            <p class="card-title mobileHeading">{{ job.job_name }}</p>
                            <div class="button-group mobileBtnGrp">
                                <button class="editBtn btn btn-warning text-white" data-bs-toggle="modal" data-bs-target="#editApplicationModal{{ job.id }}">Edit</button>
                                <button class="deleteBtn btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteModal{{ job.id }}">Delete</button>
                            </div>
                        </div>
                        <div class="mb-1">Company: {{ job.company }}</div>
                        <div>Description: {{ job.job_desc }}</div>
                        <div data-value={{job.status}} id="mobileStatusCell">Status: {{ job.status }}<i class="bi bi-dot statusDot"></i></div>
                        <div>Date Applied: {{ job.application_date }}</div>    
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="card mb-3" id="noRecordMobile">
                <div class="card-body">
                    <h5 class="text-center">No records found</h5>
                </div>
            </div>
        {% endif %}

        <!-- Pagination-->
        <div class="pagination">
            {% if jobs.has_previous %}
                <a href="?page=1">&laquo; First</a>
                <a href="?page={{ jobs.previous_page_number }}">Previous</a>
            {% endif %}
            
            <span class="current">
                Page {{ jobs.number }} of {{ jobs.paginator.num_pages }}
            </span>
            
            {% if jobs.has_next %}
                <a href="?page={{ jobs.next_page_number }}">Next</a>
                <a href="?page={{ jobs.paginator.num_pages }}">Last &raquo;</a>
            {% endif %}
        </div>

        <!-- Add Application Modal -->
        <form action="{% url 'add_application' %}" method="post" >
        {% csrf_token %}
        <div class="modal fade" id="addApplicationModal" tabindex="-1" role="dialog" aria-labelledby="addApplicationModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="addApplicationModalLabel">Add Application</h5>
                    </div>
                    <div class="modal-body">
                        <label for="company" class="mb-1">Company:</label>
                        {{ form.company }}
                        <label for="jobName" class="mb-1 mt-3">Job Title:</label>
                        {{ form.job_name }}
                        <label for="jobDesc" class="mb-1 mt-3">Description:</label>
                        {{ form.job_desc }}
                        <label for="status" class="mb-1 mt-3">Status:</label>
                        {{ form.status }}
                        <label for="dateApplied" class="mb-1 mt-3">Date Applied:</label>
                        {{ form.application_date }}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
        </form>
        <!-- Action Dialog ( For Desktop View Only )-->
        {% for job in jobs %}
        <div class="modal fade" id="actionsModal{{ job.id }}" role="dialog" aria-labelledby="actionsModalLabel{{ job.id }}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="actionsModalLabel{{ job.id }}">Actions</h5>
                        <button type="button" class="btn-close text-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <p>What do you want to do with this record?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-warning" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#editApplicationModal{{ job.id }}">Edit</button>
                        <button type="button" class="btn btn-danger" data-bs-dismiss="modal" data-bs-toggle="modal" data-bs-target="#deleteModal{{ job.id }}">Delete</button>   
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
        <!-- Edit Application Modals -->
        {% for job in jobs %}
        <form action="{% url 'edit_application' job.id %}" method="post">
        {% csrf_token %}
        <div class="modal fade" id="editApplicationModal{{ job.id }}" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                    <h5 class="modal-title">Edit Application</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <label for="company" class="mb-1">Company:</label>
                        {{ job.edit_form.company }}
                        <label for="jobName" class="mb-1 mt-3">Job Title:</label>
                        {{ job.edit_form.job_name }}
                        <label for="jobDesc" class="mb-1 mt-3">Description:</label>
                        {{ job.edit_form.job_desc }}
                        <label for="status" class="mb-1 mt-3">Status:</label>
                        {{ job.edit_form.status }}
                        <label for="dateApplied" class="mb-1 mt-3">Date Applied:</label>
                        {{ job.edit_form.application_date }}
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                </div>
            </div>
        </div>
        </form>
        {% endfor %}

        <!-- Delete Confirmation -->
        {% for job in jobs %}
        <form action="{% url 'delete_application' job.id %}" method="post">
        {% csrf_token %}
        <div class="modal fade" id="deleteModal{{ job.id }}" tabindex="-1" role="dialog" aria-labelledby="deleteModalLabel{{ job.id }}" aria-hidden="true" >
            <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                    <div class="deleteModalHead modal-header">
                        <h5 class="modal-title" id="deleteModalLabel{{ job.id }}">Delete Application</h5>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to delete the application "{{ job.job_name }}" at {{ job.company }}?</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-danger">Delete</button>
                    </div>
                </div>
            </div>
        </div>
        </form>
        {% endfor %}

        {% include 'includes/logout.html' %}
        
    </main>
{% endblock %}

{% block scripts %}
    <script src="{% static 'js/dashboard.js' %}"></script>
    <script src="https://cdn.jsdelivr.net/npm/swiper@12/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        const statusCtx = document.getElementById('statusChart');
        if (statusCtx) {
            const ds = statusCtx.dataset;
            const dataArr = [Number(ds.pending||0), Number(ds.accepted||0), Number(ds.offer||0), Number(ds.rejected||0), Number(ds.noresponse||0)];
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Pending','Accepted','Offered','Rejected', 'No Response'],
                    datasets: [{ data: dataArr, backgroundColor: ['#0d6efd','#198754','#fd7e14','#dc3545', '#757575ff'] }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
    </script>
{% endblock %}
